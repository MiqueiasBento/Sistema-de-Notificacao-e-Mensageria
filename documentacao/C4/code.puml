@startuml C4_Code_Diagram

title Diagrama de Código (Nível 4) - Sistema de Notificação e Mensageria

' Um componente costuma aparecer no diagrama de código quando ele:
' - Contém lógica de negócio relevante
' - Possui estrutura interna não trivial
' - Orquestra fluxos importantes
' - Interage com múltiplas dependências
' - É arquiteturalmente crítico

' Componentes que não entram geralmente são:
' - UI
' - Adaptadores simples
' - Wrappers
' - Componentes muito óbvios ou triviais

' Inclui o diagrama de componentes para referência
skinparam linetype ortho
skinparam components {
    FontSize 13
    FontName Arial
    BackgroundColor White
    BorderColor #444444
    ArrowColor #444444
}
skinparam package {
    BackgroundColor White
    BorderColor #888888
}
skinparam class {
    BackgroundColor White
    BorderColor #444444
    ArrowColor #444444
}

' Stereotypes styles for clarity
skinparam class<<Domain>> {
    BackgroundColor #E1F5FE
    BorderColor #0277BD
}
skinparam class<<Infrastructure>> {
    BackgroundColor #FBE9E7
    BorderColor #D84315
}
skinparam class<<CrossCutting>> {
    BackgroundColor #FFF3E0
    BorderColor #EF6C00
}

package "Producer API (Container)" {
    
    package "Ticket Module (Component)" {
        class TicketController {
            + createTicket(req, res)
        }

        class TicketService {
            + create(ticketData)
            + updateStatus(ticketData)
            + ticketResolved(ticketData)
        }

        class TicketRepository <<Infrastructure>> {
            + save(ticket)
            + findById(id)
        }
        
        class EventPublisherService {
            + publish(event: TicketCreatedEvent)
        }
        
        class TicketCreatedEvent <<Domain>> {
            + ticketId: string
            + userId: string
            + status: string
            + message: string
        }

        class JwtAuthMiddleware <<CrossCutting>> {
            + verifyToken(req, res, next)
        }

        ' Relacionamentos Internos
        TicketController ..> TicketService
        TicketService ..> TicketRepository
        TicketService ..> EventPublisherService
        EventPublisherService ..> TicketCreatedEvent : <<publishes>>
        JwtAuthMiddleware -- TicketController : intercepts
    }

    package "Admin Module (Component)" {
        class AdminController {
            + createTemplate(req, res)
            + listLogs(req, res)
        }

        class TemplateService {
            + create(template)
            + getAll()
        }

        class TemplateRepository <<Infrastructure>> {
            + save(templateData)
            + findById(id)
        }

        class NotificationLogService {
            + getLogs(filter)
        }

        class NotificationLogRepository <<Infrastructure>> {
            + findAll(criteria)
        }

        ' Relacionamentos Internos
        AdminController ..> TemplateService
        AdminController ..> NotificationLogService
        TemplateService ..> TemplateRepository
        NotificationLogService ..> NotificationLogRepository
    }

    package "Shared / Config" {
        class AwsConfig <<Infrastructure>> {
            + getSqsClient()
            + getRdsClient()
        }
    }

    ' Dependências de Infraestrutura
    EventPublisherService ..> AwsConfig : usa (SQS)
}

package "Notification Processor (Container)" {

    package "Messaging Layer" {
        class SqsListener {
            + pollMessages()
        }

        class EventRouter {
            + routeEvent(event)
            + sendNotificationToChannels()
        }

        ' Relacionamentos Messaging
        SqsListener ..> EventRouter : despacha
    }

    package "Domain Handlers" {
        class TicketCreatedHandler {
            + handleTicketCreated(event)
        }
        
        class TicketStatusChangedHandler {
            + handleTicketStatusChanged(event)
        }
    }

    package "Core Services" {
        class NotificationService {
            + send(notification)
            - fill(template, data)
        }

        class TemplateLoader {
            + load(templateKey, channel)
        }

        ' Relacionamentos Core
        NotificationService ..> TemplateLoader : usa
    }

    package "Channel Processors" {
        class EmailProcessor {
            + process(notification)
        }
        
        class PushProcessor {
            + process(notification)
        }
        
        class EmailAdapter <<Infrastructure>> {
            + sendEmail(params)
        }
        
        class FcmAdapter <<Infrastructure>> {
            + sendPush(params)
        }

        ' Relacionamentos Processors
        EmailProcessor ..> EmailAdapter : usa
        PushProcessor ..> FcmAdapter : usa
    }

    package "Logging / Persistence" {
        class DeliveryLogger {
            + logSuccess(notification)
            + logError(notification, error)
        }
        
        class RdsAdapter <<Infrastructure>> {
            + getItem(key)
            + putItem(item)
        }
    }

    ' Relacionamentos entre componentes
    EventRouter ..> TicketCreatedHandler : invoca
    EventRouter ..> TicketStatusChangedHandler : invoca
    
    TicketCreatedHandler ..> NotificationService : solicita envio
    TicketStatusChangedHandler ..> NotificationService : solicita envio

    NotificationService ..> EmailProcessor : despacha
    NotificationService ..> PushProcessor : despacha
    
    ' Trataemnto de erros / Logs
    EmailProcessor ..> DeliveryLogger : log (success/error)
    PushProcessor ..> DeliveryLogger : log (success/error)
    
    IdempotencyService ..> RdsAdapter
    TemplateLoader ..> RdsAdapter
    DeliveryLogger ..> RdsAdapter
}

@enduml
